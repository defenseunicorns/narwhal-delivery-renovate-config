{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",

  "description": "renovate configuration for eks marketplace addons",

  "customDatasources": {
    "eks-addons": {
      "defaultRegistryUrlTemplate": "https://raw.githubusercontent.com/defenseunicorns/narwhal-delivery-renovate-config/refs/heads/main/dependencies/eks-addons-versions.json",
      "format": "json",
      "transformTemplates": [
        // Use {{{packageName}}} to filter by the captured depName
        // see https://try.jsonata.org/htAy0eXsP
        "{ \"releases\": $.addons[addonName = \"{{{packageName}}}\"].addonVersions[].{\"version\": addonVersion} }"
      ]
    }
  },

  "customManagers": [
    {
      "fileMatch": [
        "(^|/).*\\.tfvars$",
        "(^|/).*\\.tf$"
      ],
      // addons populated by using - aws eks describe-addon-versions --kubernetes-version 1.32 | jq -r '[.addons[].addonName] | sort | join("|")'
      // amazon-cloudwatch-observability|aws-ebs-csi-driver|aws-efs-csi-driver|coredns|eks-pod-identity-agent|kube-proxy|snapshot-controller|vpc-cni
      // see https://regex101.com/r/Kjv2mb/3
    "matchStrings": [Z
        "(?m)^\\s{2,}(?<depName>amazon-cloudwatch-observability|aws-ebs-csi-driver|aws-efs-csi-driver|coredns|eks-pod-identity-agent|kube-proxy|snapshot-controller|vpc-cni)\\s*=\\s*\\{[\\s\\S]*?addon_version\\s*=\\s*\"(?<currentValue>[^\"]+)\""
      ],
      "datasourceTemplate": "custom.eks-addons",
      "depNameTemplate": "{{{depName}}}",
      "versioningTemplate": "loose"
    }
  ]
}
